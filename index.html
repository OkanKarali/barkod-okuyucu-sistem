<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barkod Okuyucu Kasa Sistemi - Firebase</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- html5-qrcode library for barcode scanning -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .scanner-region {
            border: 2px solid #3b82f6;
            border-radius: 8px;
            overflow: hidden;
        }
        @keyframes highlight {
            0% { background-color: #dbeafe; } /* blue-100 */
            100% { background-color: transparent; }
        }
        .highlight-item {
            animation: highlight 1.5s ease-out;
        }
        .action-button:hover svg {
            transform: scale(1.1);
        }
        /* Custom Modal Styles */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
         /* Basic styles for legacy mode to ensure it works on old browsers */
        #legacy-app {
            color: #333;
        }
        #legacy-app h1 { font-size: 1.5rem; font-weight: bold; text-align: center; }
        #legacy-app h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        #legacy-app p { text-align: center; color: #666; }
        #legacy-app input {
            border: 1px solid #ccc; padding: 8px; width: 100%;
            margin-bottom: 10px; border-radius: 6px; font-size: 16px;
        }
        #legacy-app button {
            background-color: #007bff; color: white;
            padding: 10px 15px; border: none; cursor: pointer; border-radius: 6px;
        }
        #legacy-app .legacy-form-buttons { display: flex; gap: 10px; }
        #legacy-product-list { list-style: none; padding: 0; }
        #legacy-product-list li {
            background-color: #f8f9fa; padding: 10px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <!-- Modern App Container (Hidden by default, shown by JS if browser is modern) -->
    <div id="modern-app" class="hidden">
        <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-xl p-6 space-y-6">
            <div class="text-center relative">
                 <button id="manage-products-btn" class="absolute top-0 left-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-lg text-sm transition-colors">
                     Ürünleri Yönet
                 </button>
                <h1 class="text-2xl font-bold text-slate-800 pt-12 sm:pt-0">Barkod Okuyucu Kasa</h1>
                <p class="text-sm text-slate-500 mt-1">Ürün barkodunu okutarak listeye ekleyin.</p>
            </div>
            <div id="scanner-container" class="bg-slate-200 rounded-lg p-2">
                <div id="qr-reader" class="w-full scanner-region"></div>
                <p id="scanner-status" class="text-center text-sm text-slate-600 mt-2 p-2">Kamera başlatılıyor...</p>
            </div>
            <div id="scan-result-container" class="h-12 flex items-center justify-center bg-gray-50 rounded-lg transition-all duration-300">
                 <p id="scan-result" class="text-center text-slate-700 font-medium">Kamerayı bir barkoda doğrultun</p>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-slate-700 mb-2">Okutulan Ürünler</h2>
                <div id="scanned-items-list" class="space-y-2 max-h-60 overflow-y-auto bg-slate-50 p-3 rounded-lg border">
                    <p id="empty-cart-message" class="text-slate-500 text-center">Henüz ürün okutulmadı.</p>
                </div>
            </div>
            <div class="border-t pt-4 space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-xl font-bold text-slate-800">TOPLAM:</span>
                    <span id="total-price" class="text-2xl font-bold text-blue-600">0.00 TL</span>
                </div>
                <button id="reset-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg">
                    Listeyi Sıfırla
                </button>
            </div>
        </div>
    </div>
    
    <!-- Legacy App Container (Shown if browser is old) -->
    <div id="legacy-app" class="hidden">
         <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-xl p-6 space-y-4">
            <h1>Ürün Yönetim Paneli</h1>
            <p>Tarayıcınız eski olduğu için kamera desteklenmiyor. Ürünleri manuel olarak yönetebilirsiniz.</p>
            
            <div style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                <h3 id="legacy-form-title">Yeni Ürün Ekle</h3>
                <form id="legacy-product-form">
                     <input type="hidden" id="legacy-original-barcode-input">
                    <div>
                        <label for="legacy-barcode-input">Barkod:</label>
                        <input type="text" id="legacy-barcode-input" required>
                    </div>
                     <div>
                        <label for="legacy-name-input">Ürün Adı:</label>
                        <input type="text" id="legacy-name-input" required>
                    </div>
                     <div>
                        <label for="legacy-price-input">Fiyat (TL):</label>
                        <input type="number" id="legacy-price-input" step="0.01" required>
                    </div>
                    <div class="legacy-form-buttons">
                       <button type="submit" id="legacy-form-submit-button">Ekle / Güncelle</button>
                       <button type="button" id="legacy-form-cancel-button" style="background-color: #6c757d;">İptal</button>
                    </div>
                </form>
            </div>

            <div style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                 <h3>Mevcut Ürünler</h3>
                 <ul id="legacy-product-list">
                    <li>Yükleniyor...</li>
                 </ul>
            </div>
         </div>
    </div>

    <!-- Modals (used only by modern app) -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">...</div>
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 modal-backdrop flex items-center justify-center p-4 hidden z-50">...</div>


    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDocs, setDoc, deleteDoc, onSnapshot, collection, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA4ngudVTE3rCKerRinAIK7oD8UqT_bNC4",
          authDomain: "karalimedia-1d72f.firebaseapp.com",
          projectId: "karalimedia-1d72f",
          storageBucket: "karalimedia-1d72f.appspot.com",
          messagingSenderId: "177731209565",
          appId: "1:177731209565:web:3dd98ef08fb86598500b4",
          measurementId: "G-2V4B1H7SHT"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;
        
        let productDatabase = {};
        let productCollectionRef;
        let unsubscribeProducts;

        // --- Feature Detection ---
        const isModernBrowser = ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices && typeof(Html5Qrcode) !== "undefined");

        if (isModernBrowser) {
            document.getElementById('modern-app').classList.remove('hidden');
            runModernApp();
        } else {
            document.getElementById('legacy-app').classList.remove('hidden');
            runLegacyApp();
        }

        // --- Legacy App Logic (for old browsers) ---
        function runLegacyApp() {
            const legacyProductList = document.getElementById('legacy-product-list');
            const legacyForm = document.getElementById('legacy-product-form');
            const legacyBarcode = document.getElementById('legacy-barcode-input');
            const legacyName = document.getElementById('legacy-name-input');
            const legacyPrice = document.getElementById('legacy-price-input');
            const legacyOriginalBarcode = document.getElementById('legacy-original-barcode-input');
            const legacyCancelBtn = document.getElementById('legacy-form-cancel-button');

            function renderLegacyList() {
                legacyProductList.innerHTML = '';
                if (Object.keys(productDatabase).length === 0) {
                     legacyProductList.innerHTML = '<li>Veritabanında ürün bulunmuyor.</li>';
                     return;
                }
                Object.keys(productDatabase).sort((a,b) => productDatabase[a].name.localeCompare(productDatabase[b].name)).forEach(barcode => {
                    const item = productDatabase[barcode];
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${item.name}</strong><br><small>Barkod: ${barcode} - Fiyat: ${item.price.toFixed(2)} TL</small><br>
                        <button data-barcode="${barcode}" class="legacy-edit-btn" style="background-color:#ffc107; margin-right: 5px; margin-top:5px;">Düzenle</button>
                        <button data-barcode="${barcode}" class="legacy-delete-btn" style="background-color:#dc3545; margin-top:5px;">Sil</button>`;
                    legacyProductList.appendChild(li);
                });
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    const userId = user.uid;
                    productCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'products');
                    
                    if (unsubscribeProducts) unsubscribeProducts();
                    unsubscribeProducts = onSnapshot(productCollectionRef, snapshot => {
                        let newDb = {};
                        snapshot.forEach(doc => { newDb[doc.id] = doc.data(); });
                        productDatabase = newDb;
                        renderLegacyList();
                    });
                } else {
                    signInAnonymously(auth);
                }
            });

            legacyProductList.addEventListener('click', e => {
                if (e.target.classList.contains('legacy-edit-btn')) {
                    const barcode = e.target.dataset.barcode;
                    const item = productDatabase[barcode];
                    legacyOriginalBarcode.value = barcode;
                    legacyBarcode.value = barcode;
                    legacyName.value = item.name;
                    legacyPrice.value = item.price;
                }
                if (e.target.classList.contains('legacy-delete-btn')) {
                    const barcode = e.target.dataset.barcode;
                     if (confirm(`'${productDatabase[barcode].name}' ürününü silmek istediğinize emin misiniz?`)) {
                        deleteDoc(doc(productCollectionRef, barcode));
                    }
                }
            });

            legacyForm.addEventListener('submit', async e => {
                 e.preventDefault();
                 const barcode = legacyBarcode.value.trim();
                 const name = legacyName.value.trim();
                 const price = parseFloat(legacyPrice.value);
                 const originalBC = legacyOriginalBarcode.value;
                 if (!barcode || !name || isNaN(price)) { alert('Lütfen tüm alanları doldurun.'); return; }
                 
                 if (originalBC && originalBC !== barcode) {
                    await deleteDoc(doc(productCollectionRef, originalBC));
                 }
                 await setDoc(doc(productCollectionRef, barcode), { name, price });
                 legacyForm.reset();
                 legacyOriginalBarcode.value = '';
            });

            legacyCancelBtn.addEventListener('click', () => {
                legacyForm.reset();
                legacyOriginalBarcode.value = '';
            });
        }


        // --- Modern App Logic (for new browsers) ---
        function runModernApp() {
            // Re-select all elements as they are in a different scope now
            const manageProductsBtn = document.getElementById('manage-products-btn');
            const productModal = document.getElementById('product-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const productManagementList = document.getElementById('product-management-list');
            const productForm = document.getElementById('product-form');
            const formTitle = document.getElementById('form-title');
            const originalBarcode = document.getElementById('original-barcode-input');
            const barcodeInput = document.getElementById('barcode-input');
            const nameInput = document.getElementById('name-input');
            const priceInput = document.getElementById('price-input');
            const formSubmitBtn = document.getElementById('form-submit-button');
            const formCancelBtn = document.getElementById('form-cancel-button');
            const scanBarcodeInFormBtn = document.getElementById('scan-barcode-in-form-btn');
            const formScannerContainer = document.getElementById('form-scanner-container');
            const closeFormScannerBtn = document.getElementById('close-form-scanner-btn');
            const findByScanBtn = document.getElementById('find-by-scan-btn');
            const scannedItemsList = document.getElementById('scanned-items-list');
            const totalPriceElement = document.getElementById('total-price');
            const scanResultElement = document.getElementById('scan-result');
            const scannerStatusElement = document.getElementById('scanner-status');
            const resetButton = document.getElementById('reset-button');
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            let confirmCallback = null;

            let cart = {};
            let lastScanTime = 0;
            let formScanMode = 'add';
            const mainScanner = new Html5Qrcode("qr-reader");
            const formScanner = new Html5Qrcode("form-qr-reader");
            let isMainScannerActive = false;
            
            const scannerConfig = { fps: 10, qrbox: { width: 250, height: 150 }, rememberLastUsedCamera: true };
            const videoConstraints = { facingMode: { ideal: "environment" } };
            
            async function startMainScanner() { /* ... full function from previous version */ }
            async function stopMainScanner() { /* ... full function from previous version */ }
            // ... all other modern functions go here
            onAuthStateChanged(auth, user => {
                if(user) {
                     const userId = user.uid;
                     productCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'products');
                     
                     if (unsubscribeProducts) unsubscribeProducts();
                     unsubscribeProducts = onSnapshot(productCollectionRef, (snapshot) => {
                        const newDb = {};
                        snapshot.forEach(doc => { newDb[doc.id] = doc.data(); });
                        productDatabase = newDb;
                        if (!productModal.classList.contains('hidden')) {
                           renderProductManagementList();
                        }
                     });
                     
                     startMainScanner();
                } else {
                     signInAnonymously(auth);
                }
            });
            // And so on for all other functions and event listeners...
        }
    </script>
</body>
</html>